# Reservoir input
-----
This directory contains scripts to derive a dam/reservoir input for LPJmL.

## Input
You will need a copy of the Global Reservoir and Dam (GRanD) database which can
be downloaded from: https://globaldamwatch.org/grand/

This sample application uses GRanD version 1.3 with two grid files generated by
the scripts in `../gadm_paper` and upstream area information for 4 drainage
direction maps (2 per grid file) generated by scripts in `../river_routing_paper`

## Software requirements
- `R`
- R packages `foreign`, `geosphere`, `lwgeom` (depending on version of `sf`),
  `maps`, `raster`, `RColorBrewer`, `sf`, `udunits2`

## Files included in this directory
  - paper_analysis.R: script to analyse generated reservoir inputs for paper
  - process_reservoirs.R: script to derive dam/reservoir input for LPJmL
  - README.md: this file
  - r_modules.sh: bash script that loads all required modules to run R script on
    the PIK high performance cluster

## Set up in process_reservoirs.R for sample application
  - `grand_dir`: Set to current working directory.
  - `grand_name`: Set to attribute table (*.dbf file) of GRanD version 1.3.
  - `gridname`: Set to one of two grid files.
  - `upstreamarea_RData`: Set to one of 4 RData files containing upstream areas
    for the drainage direction maps created by scripts in directory
    `../river_routing_paper`.
  - `version_string`: Set to one of 4 values describing DDMs used.
  - `search_rad`: Maximum search radius (in degree) in which to assign each dam
    to a grid cell. Default value 1 used.
  - `max_dist`: Optional maximum distance (in metres) between GRanD coordinates
    and assigned grid cell (applied on top of search radius). Set to 15000 for
    5 minute grid and 75000 for 30 minute grid.
  - `deviation_penalty`, `distance_penalty`: Power parameters used in weighting
    function (more than one value can be supplied per parameter). Combinations
    of 1 and 1.5 for each penalty used for sample application.
  - `pos_penalty`, `neg_penalty`: Allows to assign different deviation penalty
    based on whether catchment area is overshot or undershot (more than one
    value can be supplied per parameter). 1 used for both.
  - `fix_area`: Whether to estimate reservoir area for reservoirs with missing
    area in GRanD; TRUE for sample application.
  - `minimum_startyear`: Start year to use for dams/reservoirs with missing year
    information in GRanD. 1 used.
  - `last_includeyear`: Cut-off year, only include dams/reservoirs built before
    this year. 2100 used.
  - `grand_area_unit`, `grand_capacity_unit`: Units used in GRanD database.
    Defaults used.
  - `lpjml_area_unit`, `lpjml_capacity_unit`: Units used in LPJmL input (used
    for automatic unit conversion); these must match units defined in the LPJmL
    source code. Defaults used.
  - `timeline_action`: Define filter actions based on "timeline" attribute in
    GRanD database. Defaults used.
  - `bintype`: Header version used for LPJmL input format. Version 3 used.
  - `headername`: Header name used for LPJmL input format. Must match header
    name defined in LPJmL source code. Default used.
  - `manual_assignment`: optional table to prescribe grid cell assignments
    manually if automatic assignment does not give satisfactory results for
    certain GRanD dams/reservoir. No manual assignments defined for sample
    application.

The script runs automatically for all parameter combinations of
`deviation_penalty`, `distance_penalty`, `pos_penalty` and `neg_penalty`. 

## Files created by process_reservoirs.R
  - reservoir_`[[version_string_]][resolution_string]`_par`[index of parameter combination]`.bin:
    input file in LPJmL format
  - reservoir_`[[version_string_]][resolution_string]`_par`[index of parameter combination]`_settings.csv:
    CSV table listing parameter values used to create matching input file
  - reservoir_diagnostics_`[[version_string_]][resolution_string]_[number of parameter combinations]`_settings.pdf:
    maps showing GRanD dam and reservoir locations and assigned grid cells for
    all parameter combinations
  - reservoir_diagnostics_`[[version_string_]][resolution_string]_[number of parameter combinations]`_settings.Rdata:
    some diagnostics which can be used to analyse grid cell assignment, such as
    distance between GRanD coordinates and assigned grid cell
