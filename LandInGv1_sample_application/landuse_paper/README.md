# Landuse input
-----
This directory contains scripts to generate a landuse input dataset.

## Input
The subdirectories included in this directory are for the various source
datasets used to generate the landuse dataset. See README file in each
subdirectory for further instructions regarding each source dataset.

The scripts in this directory require data generated by the scripts in
`../gadm_paper` so make sure to run these first.

This sample application creates landuse inputs for two grid files generated by
the scripts in `../gadm_paper`, one at 5 arc-minute and the other at 30 
arc-minute spatial resolution. The final landuse inputs cover the period
1500-2017.
Data processing from the source datasets to a gridded time series of
crop-specific rainfed and irrigated harvested areas is carried out at 5 minute
resolution. The 30 minute dataset is generated by aggregating the 5-minute time
series in the last processing step.

In addition to the standard inputs describing growing areas (which cannot exceed
grid cell area), a time series of harvested areas is also generated in LPJmL
format at 5 minute spatial resolution. This is only used for analysis in the
paper. Harvested areas can exceed the grid cell area.

## Software requirements
- `R`
- R packages `abind`, `data.table`, `ncdf4`, `raster`, `stringi`, `udunits2`
- shell scripts in `/HYDE` require `bash`, `cdo`, `nco`, `zip`

## Files included in this directory
- aggregate_cft_timeseries.R: Script aggregates full list of crops included in
  FAOSTAT/Monfreda to CFTs simulated by LPJmL
- aggregate_cft_timeseries_SLURM.sh: Example batch script to run
  aggregate_cft_timeseries.R as a job on the PIK cluster
- cft_input_timeseries.R: Script generates landuse inputs in final LPJmL format,
  run for grid files at 5 minute and 30 minute resolution for sample application
- cft_input_timeseries_SLURM.sh: Example batch script to run
  cft_input_timeseries.R as a job on the PIK cluster
- cft_input_timeseries_harvested_area.R: Modified from script above to generate
  a time series of harvested areas in LPJmL format, run only at 5 minute
  resolution
- country_level_data.R: Script that matches crops between FAOSTAT and Monfreda
  at the country scale
- crop_types_aquastat.csv, crop_types_FAOSTAT_LPJmL_default.csv,
  crop_type_Monfreda_FAOSTAT_MIRCA.csv: Mappings between crop naming schemas
  used in the different source datasets
- harvested_area_timeseries.R: Script disaggregates country time series of
  rainfed and irrigated harvested areas to the grid
- harvested_area_timeseries_SLURM.sh: Example batch script to run
  harvested_area_timeseries.R as a job on the PIK cluster
- harvested_fraction.R: Script converts gridded harvested areas from Monfreda
  into harvested fractions, provides gap filling and removes some pattern
  artefacts caused by mismatches in country masks
- harvested_fraction_SLURM.sh: Example batch script to run harvested_fraction.R
  as a job on the PIK cluster
- landuse_setup.R: This file contains most settings used by all the other R
  scripts in this directory. You have to set up filenames to files downloaded
  for the various source datasets, units etc.
- multi_cropping_suitability_GAEZ.R: Script calculates multicropping suitability
  based on agro-climatic resources from GAEZ
- paper_analysis.R: Script to analyse generated inputs for paper
- read_AQUASTAT.R: Script reads data downloaded from AQUASTAT database and
  converts format for further use. This script can be run in interactive or
  non-interactive mode to deal with values with additional metadata
- read_FAOSTAT.R: Script reads data downloaded from FAOSTAT database and
  converts format for further use.
- r_modules.sh: Loads modules on the PIK cluster required to run R with all the
  packages used by the scripts in this directory
- split_global_harvested_areas_into_rainfed_irrigated.R: Script combines MIRCA
  and AQUASTAT with FAOSTAT to derive rainfed and irrigated harvested areas at
  the country scale

## Steps used for sample application
- Collect source datasets following README in each subdirectory. This sample
  application uses FAOSTAT data downloaded on January 27, 2020 and AQUASTAT data
  downloaded on April 17, 2020. These source datasets are updated regularly by
  their providers, replacing previously available data. All other source
  datasets are available in the versions used for this application from the
  listed sources.
- Run shell scripts in subdirectory `HYDE` to preprocess HYDE source data for
  use in R scripts.
- Fill out setup in `landuse_setup.R`. This setup does not depend on whether the
  final dataset is created for the 5 minute or 30 minute grid file.
- Generate a timeseries of gridded crop-specific harvested areas.
	1) `read_FAOSTAT.R`
	2) `country_level_data.R` (requires step 1)
	3) `harvested_fraction.R` (requires step 2)
	4) `read_AQUASTAT.R` (does not require steps 1 to 3)
	5) `multi_cropping_suitability_GAEZ.R` (does not require steps 1 to 4)
	6) `split_global_harvested_areas_into_rainfed_irrigated.R` (requires steps 1
      to 5)
	7) `harvested_area_timeseries.R` (requires steps 1 to 6)
- Aggregate crop-specific harvested areas to crop-functional types (CFTs)

	8) `aggregate_cft_timeseries.R` (requires steps 1 to 7)
- Convert timeseries of CFT-specific harvested areas into input for LPJmL. This
  step is run for each of the two grid files separately.
  
	9) `cft_input_timeseries.R` (requires steps 1 to 8).

Note: The scripts `harvested_area_timeseries.R` and `aggregate_cft_timeseries.R`
are not parallelized explicitly. To speed up processing, the full time period
was split into shorter chunks by manually setting `start_year` and `end_year` in
`aggregate_cft_timeseries_SLURM.sh` and `harvested_area_timeseries_SLURM.sh` and
processing several chunks in parallel.
