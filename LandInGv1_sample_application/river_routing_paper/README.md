# River routing input
-----
Scripts in this directory create input files related to river routing.

## Input
  1) a grid file, as generated by scripts in `../gadm_paper`
  2) a drainage direction map in the correct spatial resolution
  3) a land fraction file (optionally), as generated by scripts in `../gadm_paper`

## Files included in this directory
  - create_river_routing_input.sh: Shell script to convert drainage direction
    map into LPJmL river routing input format.
  - drainage: utility compiled from LPJmL model repository
    https://github.com/PIK-LPJmL/LPJmL to convert drainage direction map into
    river routing input for LPJmL
  - neighbour_irrigation.R: Script to derive neighbour irrigation cells.
  - neighbour_irrigation_SLURM.sh: Example batch script to submit
    neighbour_irrigation.R as a job on the PIK high performance cluster.
  - paper_analysis.R: Script to analyse resulting river routing and neighbour
    irrigation inputs for paper
  - README.md: This file.
  - river_routing.R: Script to derive lists of upstream cells, downstream cells,
    and upstream areas based on river routing input file.
  - r_modules.sh: Example shell script to load necessary modules to run R
    scripts on PIK high-performance cluster.
  
## Software requirements
- `drainage` utility from LPJmL model repository
- `R`
- R packages `foreach`, `geosphere`, `raster`, to use MPI backend for
  parallelization: `doMPI`, `Rmpi`; or use `doParallel`, `parallel` to run on
  multiple CPUs of a local machine.
  
## Setup for create_river_routing_input.sh
  - `DRAINAGEBIN`: Set to drainage utility included in this publication. Should
    normally be compiled from up-to-date LPJmL model repository.
  - `LPJGRID`: Set to one of two grid files.
  - `DDMASCII`: Set to one of 4 drainage direction maps in ASCII grid format;
    grid and DDM resolution must match.
  - `RIVERROUTINGFILE`: Set to one of 4 river routing filenames to be created.

Note: The HydroSHEDS drainage direction map comes in Tiff format and does not
cover the full spatial extent of the grid file. README file in subdirectory
`HydroSHEDS_v1.1` contains information on how to prepare an ASCII grid for use
in `create_river_routing_input.sh`.

## Setup for river_routing.R
  - `drainagedir`: Current working directory.
  - `gridname`: Set to one of two grid files.
  - `drainname`: Set to one of 4 river routing filenames created by
    `create_river_routing_input.sh`.
  - `landfracname`: Not used.
  - `version_string`: Set to one of 4 values describing DDMs used.

## Setup for neighbour_irrigation.R
  - `drainagedir`: Current working directory.
  - `gridname`:  Set to one of two grid files.
  - `drainname`: Set to one of 4 river routing filenames created by
    `create_river_routing_input.sh`.
  - `cluster`: Whether to try parallelization on a multi-CPU cluster. Set to TRUE
  - `version_string`: Set to one of 4 values describing DDMs used.
  - `search_area`: Where to look for neighbour cell, either directly "adjacent"
    cells or cells within search "region". Tested both "adjacent" and "region"
    for all 4 DDMs.
  - `search_radius`: Maximum distance of neighbour cells if `search_area` is
    "region". Set to 75000 metres.
  - `exclude_upstream`: Whether to exclude all upstream cells as potential
    neighbour cell. TRUE and FALSE tested for `search_area <- "adjacent"`, always
    TRUE for `search_area <- "region"`.
  - `exclude_downstream`: Whether to exclude all downstream cells as potential
    neighbour cell. TRUE and FALSE tested for `search_area <- "adjacent"`, always
    TRUE for `search_area <- "region"`.
  - `idw_power_par`: Power parameter used for inverse distance weighting of
    potential neighbour cells (set to 0 for no weighting). Values of 0 and 2
    tested.
  - `neighbour_format`: File format for neighbour irrigation input file, "BIN"
    for LPJmL native input format, or "CSV". "BIN" used.
  - `bintype`: Header version used for "BIN" format. Version 3 used.
  - `neighbour_headername`: Header name used for "BIN" format. Must match header
    name defined in LPJmL source code. Default used.

## Steps used for sample application
Sample application conducted for 2 grid files (5 arc-minute and 30 arc-minute
resolution) generated by scripts in `../gadm_paper`

  1) Prepare HydroSHEDS drainage direction map for use following instructions in
    `HydroSHEDS_v1.1/README.md`.
  2) Run `create_river_routing_input.sh` for 2 drainage direction maps per
    spatial grid resolution. See drainage direction maps below.
  3) Run `river_routing.R` for each drainage direction map processed in step 1.
  4) Run `neighbour_irrigation.R` with 4 different assignment settings for each
    of the 4 drainage direction maps processed in step 2.

Drainage direction maps are provided by, for example:
- STN-30: https://wsag.unh.edu/Stn-30/stn-30.html (global, 0.5°), used in sample
  application for 30 arc-minute resolution
- DDM30: https://www.uni-frankfurt.de/45218101/DDM30 (global, 0.5°), used in
  sample application for 30 arc-minute resolution
- HydroSHEDS: https://hydrosheds.org/ (continental scale, 3 arc-second, 15
  arc-second, 30 arc-second, 5 arc-minute, 6 arc-minute), used in sample
  application for 5 arc-minute resolution
- Upscaled versions of HydroSHEDS (not using "official" HydroSHEDS upscaling
  methods, see Wu et al. 2012 below):
  http://files.ntsg.umt.edu/data/DRT/upscaled_global_hydrography/by_HydroSHEDS_Hydro1k/
- MERIT Hydro: http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_Hydro/ (global
  scale, 3 arc-second)
- Upscaled versions of MERIT Hydro (see Eilander et al. 2021 below):
  https://doi.org/10.5281/zenodo.5166932, used in sample application for 5 
  arc-minute resolution

The toolbox does *not* provide functionality to rescale a drainage direction map
to a different spatial resolution. The HydroSHEDS technical documentation
provides some guidance on upscaling a drainage direction map:
https://hydrosheds.org/page/development

The following publications also describe upscaling methods:
- Eilander et al. (2021): "A Hydrography Upscaling Method for Scale-Invariant
  Parametrization of Distributed Hydrological Models", Hydrology and Earth
  System Sciences 25 (9): 5287–5313. https://doi.org/10.5194/hess-25-5287-2021.
- Wu et al. (2012): "A New Global River Network Database for Macroscale
  Hydrologic Modeling", Water Resources Research 48 (9): 2012WR012313.
  https://doi.org/10.1029/2012WR012313.
